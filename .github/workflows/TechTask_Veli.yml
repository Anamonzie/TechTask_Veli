name: Playwright Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]


jobs:
  test:
    timeout-minutes: 60
    runs-on: windows-latest

    strategy:
      matrix:
        browser: [chromium, firefox, webkit]  # Parallelizing across different browsers
        playwright-version: [1.44.0] 

    steps:    
    # Step 2: Checkout the code
    - name: Checkout repository
      uses: actions/checkout@v4

    # Step 1: Set up JDK
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: zulu
        java-version: 21

    # Step 3: Set up .NET
    - name: Set up .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'  # your .NET version

    # Step 4: Install Playwright package
    - name: Install Playwright
      run: npm install @playwright/test
      
    # Step 5: Install all required libraries using Playwright script
    - name: Install Playwright Dependencies
      run: npx playwright install-deps

    # Step 6: Build & Install   
    - name: Build & Install
      run: dotnet build

    # Step 7: Install Playwright Browsers
    - name: Install Playwright Browsers
      run: npx playwright install

    # Step 8: Build the project
    - name: Build the project
      run: dotnet build --configuration Release --no-restore --verbosity detailed

    # Step 9: Run Playwright Tests
    - name: Run Playwright Tests
      run: dotnet test TechTaskVeli.Tests/TechTaskVeli.Tests.csproj --configuration Release --no-build --verbosity normal
      env:
        BROWSER: ${{ matrix.browser }}
    
report:
    needs: test
  
    runs-on: ubuntu-latest
  
    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4.1.0
        with:
          name: allure-results
          path: ./allure-results
  
      - name: Get Allure history (optional)
        uses: actions/checkout@v4
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages
  
      - name: Generate report
        uses: simple-elf/allure-report-action@v1.7
        if: always()
        id: allure-report
        with:
          allure_results: allure-results
          gh_pages: allure-report
          allure_history: allure-history
          keep_reports: 20
  
      - name: Deploy report to Github Pages
        if: always()
        # uses: peaceiris/actions-github-pages@v4
        uses: peaceiris/actions-gh-pages@v4
        with:
          PERSONAL_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PUBLISH_BRANCH: gh-pages
          PUBLISH_DIR: allure-report